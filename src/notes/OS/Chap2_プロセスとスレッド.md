---
title: 2章 プロセスとスレッド
tags: 
    - OS
date: 2025/11/13
---

# 2章 プロセスとスレッド
::: info
本項は「モダンオペレーティングシステム 第5版」を読んだ際のまとめとして記録したものです。
:::

## 2.1 プロセス
プロセスは、OSが提供する最も重要な抽象化の1つであり、プログラムの同時実行を可能とする。
例えば、Webサーバを考える。Webサーバは、クライアントから要求を受信すると、必要なページがキャッシュされているかを確認する。
それがキャッシュに存在しない場合、ディスクに要求を飛ばし、ページを取得しようとする。
一般的に、ディスクI/OはCPU処理よりもはるかに遅い。ディスクの応答を待っている間、プログラムは応答を待つだけである。
この間にCPUが他の作業を行うことができれば、システムのスループットを向上させることができる。

実際、OSは複数のプロセスの同時実行を制御している。各CPUは、瞬間的には1つのプロセスのみを実行しているが、OSが非常に短い時間間隔(数10ミリ秒程度)でプロセスを切り替えることで、あたかも複数のプロセスが同時に実行されているかのように見せかけている。
また、**マルチプロセッサシステム**は、真の並列処理を実現可能とする。すなわち、複数のプロセッサが同時に異なるプロセスを実行することができる。

### 2.1.1 プロセスモデル
コンピュータ上で実行されるソフトウェアは、通常複数の**シーケンシャルプロセス**、すなわち**プロセス**で構成される。
各プロセスは、それぞれ独立の
- プログラムカウンタ
- レジスタ
- 変数の現在値

をもつ。結果として、各プロセスはそれぞれが独自のCPUをもっているかのように振る舞う。

CPUがプロセスを実行する時間、すなわち各プロセスが1回当たりの計算に割り当てられる時間は一定ではない。
例えば、別のコアによって再生されるビデオにあわｓてオーディオを再生する場合を考える。
オーディオの再生をビデオ再生の１秒後に行う、とすると、次のような手順が考えられるかもしれない。
1. ビデオサーバに再生の信号を送る
2. 1秒分空ループを回して待つ
3. オーディオの再生を開始する

この方法には問題がある。2のループ中にCPUの実行が他のプロセスに切り替わった場合、オーディオの再生の開始が遅れてしまう可能性がある。
実行のタイミングが重要なプロセスでは、特別な処理が必要となる。

### 2.1.2 プロセスの生成
プロセスは、以下のタイミングで生成される。
- システムの初期化
- プロセスがプロセス生成のシステムコールを発行したとき
- ユーザからプロセスの生成要求があったとき
- (パッチジョブを開始したとき)

システムの初期化、すなわちOSの起動時には多数のプロセスが生成される。
これらは電子メールの受信、Webページのアクセス処理など、常にはCPU資源を消費する計算を行わないが、特定のイベントが発生したときに処理が必要なプロセスである。
このようなプロセスは、要求に備えて待機しており、**daemon(デーモン)**と呼ばれる。

技術的には、プロセスは常に既存のプロセスからシステムコールを通じて生成される。
UNIXでは、`fork`システムコールが唯一のプロセス生成手段である。このシステムコールは、呼び出し元プロセスの正確なコピーを生成する。
すなわち、新しいプロセスは親プロセスと同じコード、データ、オープンファイルをもつ。
新しいプロセスは、`execve`などのシステムコールを通じてメモリイメージ(つまり、実行するコード)を変更して、異なるプログラムを実行することができる。
この２段階の処理の間でファイル記述子を操作することで、パイプラインやリダイレクトといった機能が実現される。

Windowsでは、`CreateProcess`という呼び出しがプロセス生成とプログラムのロードを同時に行う。

### 2.1.3 プロセスの終了
プロセスは以下のタイミングで終了する。
1. 正常に終了したとき
2. エラーで終了したとき
3. 致命的エラーが発生したとき
4. 他のプロセスから強制終了させられたとき

正常に終了、あるいはエラーを発見して終了したときの呼び出しは、UNIXでは`exit`システムコール、Windowsでは`ExitProcess`関数が使われる。
致命的エラーは、メモリアクセス違反やゼロ除算など、プロセスが引き起こしたエラーによって生じる。
UNIXでは、これらのエラーはシグナルとしてプロセスに通知され、ハンドリングを行うことができる。ハンドリングを行わない場合、OSがプロセスを強制終了する。

また、プロセスは他のプロセスから強制終了させられることがある。UNIXでは、`kill`システムコールを通じてシグナルを送信し、プロセスを終了させることができる。
Windowsでは、`TerminateProcess`関数を使ってプロセスを強制終了させることができる。

::: info
これらの呼び出しで強制終了されるプロセスは、指定したプロセスのみであり、そのプロセスが生成したプロセスまでは終了しない。
:::

### 2.1.4 プロセスの階層
プロセスがプロセスを生成するとき、それらのプロセス間において親子関係を構成することができる。
UNIXにおいては、プロセスとその全ての子孫プロセスは1つの**プロセスグループ**を形成する。
ユーザーがキーボード割り込み(ctrl+C)でSIGINTシグナルを送信したとき、そのシグナルはプロセスグループ全体に送信される。
シグナルを受け取ったプロセスは、それぞれのシグナルハンドラを実行するか、デフォルトの動作として終了する。

::: info
Windowsでは、プロセスは親子関係をもたない。累次の概念として、プロセスを生成したとき、親側のプロセスは、生成した子プロセスの**ハンドル**というトークンを受け取る。
このトークンは他のプロセスに渡すことができる。
:::