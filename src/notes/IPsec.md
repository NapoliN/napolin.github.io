# IPsec
ネットワーク層でのの暗号化プロトコル
複数のプロトコルから構成されるアーキテクチャ

- プロトコル (AH/ESP/AH+ESP)
- 暗号化アルゴリズム (DES/3DES/AES)
- 認証 (MD5/SHA)

## 概要

### プロトコル
#### AH Authentication Header
データの改ざん防止・送信元の認証が行える
**暗号化はしない**

#### ESP Encapsulating Security Payload
データの暗号化・送信元の認証が行える

### 暗号化アルゴリズム
#### AES Advanced Ecryption Standard
共通鍵暗号方式

#### RSA

### 認証方法
#### PSK Pre-Shared Key
事前に共有された鍵で認証する方法。両方の機器で同じ文字列を設定しておく
#### デジタル署名
RSAを使った署名方式。データをハッシュ化してダイジェストを生成。それを秘密鍵で暗号化しデジタル署名とする。それを相手に送る
相手側でもデータをハッシュ化して、ダイジェストを生成。また、相手の公開鍵で送られてきたデジタル署名を復号する。
「ダイジェストが一致する」ことによって改ざんされていない＋送信元が公開鍵の持ち主である ことが認証できる
#### ユーザ名とパスワード
簡易的な認証で、VPNなどで使う

## 流れ
### 1. IKEフェーズ1: セキュアなチャンネルの確立
#### 1.1 ネゴシエーション
暗号化方式。・認証方式・ハッシュ方式・鍵交換方式(DH1/DH2/DH3)を提案
送られた側は、同意できる方式を選択
#### 鍵交換
同意したDHのバージョンを用いて、共有鍵を生成
→ 以降の通信はこの共有鍵で暗号化
#### 相互認証
双方が同意した認証方式で、相手の正当性を確認する。
→ ISAKMPが確立

::: info
- メインモード IPアドレスを認証に利用する 6回のメッセージ交換
- アグレッシブモード: IPsecを認証情報として利用しない(動的IPでも利用可能) 3回の交換 認証情報が平文で送られるためやや危険
:::

### フェーズ2： SAの確立
#### 2.1 IPsec SAのネゴシエーション
- ESP/AH ・ 暗号化アルゴリズム　・　認証アルゴリズム　を選択
- SPIを交換

フェーズ2でさらに新しい鍵を生成すると、完全前方秘匿性(PFS)が達成される
フェーズ1で生成した鍵・あるいは新しく生成した鍵から、鍵派生関数(KDF)を用いて新しく鍵を生成
→ これを実際のIPsec通信の暗号化鍵として利用

## セキュリティポリシー
- BYPASS そのまま通過
- DISCARD 廃棄
- PROTECT 暗号化

### IPsecパススルー
IPsecを適用したパケットは↓の構造になる
IPヘッダ-ESPヘッダ-暗号化データ-ESP認証データ
NAPTを嚙ませようとすると、ポート番号がないので上手くいかない
→ IPヘッダのタイプがESPなら、ポート変換しない(ＩＰのみ変更)
::: error
    複数のIPsec通信を確立できない
:::

### NATトラバーサル
IPヘッダとESPヘッダの間にUDPをさらに挿入する
IKEで経路上にNAPTが存在することを検出する必要がある
→ IKEのやり取りに使うポート番号の500が変更されていたらNAPTがあると認識できる

## 受信時の処理
- IPヘッダを見て、プロトコル番号がESPである
- ESPヘッダのSPIを見て、対応するSADから鍵とかを取り出す
- 改ざんの検証して、データの復号
- 復号したら元のIPヘッダを見て転送