---
title: セキスペ入門 SSO
tags: 
    - セキスペ
date: 2025/10/20
---

# SSO
Single Sign-On.
一度の認証で色んなサービスを利用できる仕組みのこと。

## SAML方式
Security Assertion Markup Language. OASISにより標準化されている。SAML 2.0 Core参照。
「IdPがどのようにユーザを認証したか」という認証結果のやり取りの方法を規定している。

登場人物は以下の3つ。
- IdP Identity Provider 認証を提供するサービス
- SP Service Provider 利用したいサービス
- ユーザ(Principal)

重要ワード
- Assertion 認証結果を表すXMLデータ。いつ、誰が、何を使うことを許可されたか、などの情報を含む。
- Protocol SPとIdP間でAssertionをやり取りするためのルール
- Binding Protocolをどのように伝送するかのルール。

### フロー
1. ユーザがSPにアクセス
2. SPはAuthnRequestを生成し、ユーザをIdPにリダイレクト
3. ユーザはIdPを通じて認証(プロトコルは自由)
4. IdPはAssertionを生成し、ユーザをSPにリダイレクト
5. SPはAssertionを検証し、ユーザにサービスを提供

Step3でユーザが既に認証済みであれば、再度認証が要求されない=SSOが実現される。

## Kerberos方式
RFC4120参照。
ネットワーク上で認証を行うためのプロトコル。
登場人物は以下の3つ。
- KDC Key Distribution Center 認証サーバ
    - AS Authentication Server ユーザの認証を行うサーバ
    - TGS Ticket Granting Server サービスの利用を許可するチケットを発行するサーバ
- サービスサーバ ユーザが利用したいサービスを提供するサーバ
- ユーザ
チケットという「ユーザの認証情報」を用いる。
- TGT Ticket Granting Ticket KDCが発行する、KDCに対してユーザの認証を要求するためのチケット
- ST Service Ticket KDCが発行する、サービスサーバに渡すユーザの認証情報を含むチケット

各チケットには有効期限があり、期限が切れると再度認証が必要になる。
### フロー
ここで扱う「鍵」は、共通鍵暗号方式による鍵。
パスワードから生成されるハッシュ値を用いて「長期鍵」を生成する。これはKDC・ユーザ間で送信されるわけではないが、それぞれで同じ値を生成可能である。
(KDCにはユーザのパスワードのハッシュ値が保存されており、ユーザはパスワードから長期鍵を生成できる)

1. ユーザがASにTGTの発行を要求(AS-REQメッセージ)
2. ASはKDCのDBからユーザ情報を取得し、対応するユーザのTGTを発行し、そのユーザの鍵によって暗号化してユーザに返す(AS-REPメッセージ)
3. ユーザは自分のパスワードから長期鍵を生成し、ASから送られてきたTGTを復号する

### Pre-auth
前述のフローの説明では、TGTは認証の有無にかかわらず発行される。
このフローでは、攻撃者はAS-REPを取得できてしまうため、オフラインで総当たり攻撃を行うことでTGTを復号することが可能である。
この攻撃のことを「AS-REP Roasting攻撃」という。
1. ユーザは現在時刻のタイムスタンプを長期鍵で暗号化した情報(PA-ENC-TIMESTAMP)を付与し、ASにTGTの発行を要求(AS-REQメッセージ)
2. ASはKDCのDBからユーザ情報を取得し、対応する長期鍵で復号。復号可能性によってユーザを認証し、時刻差から正当性を確認する。

攻撃者が盗聴を行った場合、1のリクエストをリプレイすることで不正にAS-REPメッセージを取得できてしまう。
これを防ぐため、さらに別の手段で「リプレイ攻撃が行えないこと」を保証する必要がある。
- リプレイキャッシュ (過去に受け取ったAS-REQの情報を保存し、同じ情報が来たら拒否する)

### AS-REP Roasting 攻撃
ユーザが認証されていなくてもTGTを含むAS-REPメッセージが返されてしまうことを悪用した攻撃。
pre-authを有効にすることで防ぐ。
1. ドメインのユーザ一覧を列挙する。
2. 片っ端からAS-REQを送信する。pre-authが無効なユーザであれば、AS-REPが返ってくる。
3. 返ってきたAS-REPを保存し、オフラインで総当たり攻撃を行う。

### Kerberoasting 攻撃
AS-REP Roastingと同様に、オフラインで総当たり攻撃を行うことでサービスチケットを復号する攻撃。
#### 前提条件
- 攻撃者は、TGTを発行されているアカウントを操作できる(ネットワーク内に侵入し、何らかのホストを乗っ取っている)
- 攻撃対象がSPNを登録している

#### フロー
1. 攻撃者はTGTを用いて、任意のSPNを指定してTGS-REQを送信する。KDCは攻撃者が指定したSPNに対応するサービスチケットを発行し、攻撃者に返す。
2. 攻撃者は返ってきたTGS-REP(サービスアカウントの長期鍵で暗号化)を保存する。
3. 攻撃者はオフラインで総当たり攻撃を行い、サービスアカウントの長期鍵を復元する。
4. 復元したパスワードを用いて、サービスアカウントとしてログインする。

#### 対策
- 不必要なSPNを登録しない(通常のユーザへはSPNを登録しない)
- サービスアカウントのパスワードを定期的に変更、複雑にする
- Kerberosの暗号化方式をAESにする(TGS-REPの暗号化にRC4を使うと、攻撃が容易になる)

### Pass-the-Ticket攻撃
盗み取ったTGTやSTを用いて、不正に認証を行う攻撃。
AS-REP RoastingやKerberoasting攻撃のように、特定の手順によって成り立つ、という概念ではなく、盗み取ったチケットを用いて行う攻撃全般を指す。
不正に取得したTGTをゴールデンチケット、STをシルバーチケットと呼ぶ。

::: info
**Active Directory**
Windows環境で広く使われているディレクトリサービス。
LDAPをベースにしており、認証としてKerberosを使い、SSOを実現している。
STを発行する際にLDAP上のユーザ情報を参照し、アクセスの可否を判断することができる。
:::

## OAuth2.0
認可のためのフレームワーク。
他のサービスに対して、自分の認証情報を渡すことなく、限定的なアクセス権を与えるための仕組み。
xxのアカウントでログイン、などWebサービスでよく見かける。

### 登場人物
- リソースオーナー Resource Owner ユーザ
- クライアント Client リソースオーナーに代わって、リソースサーバにアクセスするアプリケーション (例: Twitterに代理で投稿するアプリ)
- リソースサーバ Resource Server 保護されたリソースを提供するサーバ (Twitter APIなど)
- 認可サーバ Authorization Server クライアントにアクセストークンを発行するサーバ (Twitterなど)

### フロー 
1. リソースオーナー(以下、ユーザ)がクライアントへサービスを要求
2. クライアントは要求を認可サーバにリダイレクトする
3. ユーザは認可サーバに対し、認証情報とともに認可要求を送信する
4. 認可サーバはユーザを認証し、認可コードを発行した上で、ユーザをクライアントへリダイレクトさせる
5. ユーザはクライアントへ認可コードを送信する
6. クライアントは認可コードを用いて、認可サーバにアクセストークンを要求
7. 認可サーバは認可コードを検証し、アクセストークンを発行
8. クライアントはアクセストークンを用いて、リソースサーバにアクセスし、保護されたリソースを取得

### PCKE
Proof Key for Code Exchange by OAuth Public Clients.
上記のフローにおいて、第３者に認可コードを盗まれた場合、認可サーバは第３者にアクセストークンを発行してしまう。
PCKEでは、クライアントが認可コードを要求する際に、code_verifierというランダムな文字列を生成し、そのハッシュ値(code_challenge)を認可サーバに送信する。
認可サーバはcode_challengeを保存しておき、クライアントがアクセストークンを要求する際に、code_verifierを送信させ、検証する。
この検証により、認可コードを発行した相手と、認可コードを送信してきた相手の同一性を確認できる。

フローでは、2番のタイミングでユーザにcode_challengeを送信し、3番でそれを認可サーバに送信させる。
さらに6番でクライアントがcode_verifierを認可サーバに送信する。

攻撃者がリダイレクト先を書き換え、認可コードを横取りする、などの攻撃に対して有効。