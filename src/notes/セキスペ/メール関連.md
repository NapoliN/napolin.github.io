---
title: セキスペ入門 メール
tags: 
    - セキスペ
date: 2025/10/20
---

# メール

基本的なプロトコルの内容は別途書くかもしれない。
このノートでは、送信者認証/暗号化/スパム対策など、セキュリティに関連する内容についてまとめる。

## お品書き
- 送信者認証
    - SMTP AUTH
    - SPF
    - DKIM
    - DMARC
    - (FCrDNS)
    - (POP before SMTP)
- 暗号化
    - PGP(OpenPGP)
    - S/MIME
    - SMTP over TLS
    - STARTTLS
- スパム対策
    - OP25B
    - IP25B
    - サブミッションポート


## 送信者認証
### SMTP AUTH
送信側メールサーバで利用者を認証する仕組み。認証が成功した場合のみ送信が許可される。

### DKIM
DomainKeys Identified Mail.
デジタル署名を送信ドメイン認証を行い、なりすましや改ざんの検知を行う技術。
#### 送信側
下準備として、DNSのTXTレコードに署名の検証に用いる公開鍵を登録する。

送信時、次の処理を行う。
1. メール送信時、ヘッダの一部＋本文をハッシュ化し、秘密鍵で署名を付与する。
1. 署名・セレクタ・送信ドメイン等をメールのヘッダ(DKIM-Signature)に追加する。

::: info
**DNSサーバに登録するレコードのフォーマット**
```
<seletor>._domainkey.<domain> IN TXT v=DKIM1; k=<algorithm>; p=<pub_key_encoded_base64>
```
:::

::: info
**署名する範囲について**

Receivedヘッダなど、配送経路で追加されることが予想されるヘッダは署名対象外にする。
署名の対象とした範囲に変更が施されると、検証に失敗し、改ざんとして扱われてしまう可能性がある。

余談として、本文の署名範囲も指定することもできる。基本は全文を対象にする(それはそう)。
:::

#### 受信側
受信したメールに対して、次の処理を行う。
1. DKIM-Signatureヘッダを確認し、対応するFQDNに対してDNSで問い合わせ、サーバの公開鍵を取得する。
2. 公開鍵で署名を検証する。

::: warning
DKIMで検証できるのは
- メール本文・ヘッダが改ざんされていないこと
- DKIM-signatureに指定されたドメインが送信を許可していること

であり、次のことは検証できない。
- 本当にそのドメインから送られたかどうか
:::

### SPF
Sender Policy Framework.
メールの送信元が、そのメールの送信元ドメインが指定するサーバであるか確認する仕組み。
#### 送信側
ドメイン管理者は、DNSのテキストレコードに、管理ドメインのメールの正しい送信サーバ(IPアドレス/ホスト名)を記述する
#### 受信側
受信メールのEnvelope-fromで指定されたアドレスのドメインに問い合わせ、SPFレコードを取得
送信元IPアドレスが、SPFレコードによって許可されているか検証する

SPFレコードにinclude:でホスト名が記述されていた場合、そのホストに対してSPFレコードをさらに参照する
redirect=でホスト名が記述されていたとき、評価はリダイレクト先に丸投げされる

::: danger
SPF単体では本文・ヘッダの改ざん検知を行うことができない。
また、転送してしまうと送信元IPが変わるので失敗してしまう。
:::

### DMARC
Domain-based Message Authentication, Reporting, and Conformance.
受信サーバによるSPFとDKIM、およびFromドメインの整合性の検証結果から、**送信サーバが**それをどう扱うか指示する仕組み。
ドメイン管理者は _dmarc.<domain> のTXTレコードにDMARCの情報を記載する。

::: info
Fromヘッダとの整合性チェック
SPF/DKIMで検証された結果と、Header-fromのドメインが一致しているか確認
(SPF or DKIM) and Header-from が真なら合格(つまり、SPFかDKIMのどちらかは失敗しても通る)
正当なメールでもSPFやDKIMが失敗する可能性は十分にあり得る
:::

#### ポリシーの運用
SPF・DKIM・Fromドメイン検証のいずれかが失敗したメールをどのように扱うか
- none 失敗を拒否せず、レポートのみ受け取る
- quaratine 迷惑メールに隔離する
- reject 受信拒否する

### FCrDNS
Foward-confirmed revers DNS.
メールを送ってきた送信サーバのIPアドレスを逆引きして、得られたホストの正引き結果がもとに戻るかを検証。

クラウド/レンタルサーバでは、1つのIPを複数ドメインが共有するケースがある。
そうしたケースでは逆引きが正しく検証できない場合がある。

### POP before SMTP
メール送信前に、POP3で認証を行う仕組み。
POP3で認証が成功したIPアドレスからのSMTP送信を一定時間許可する。

::: warning
DKIMリプレイ攻撃ってのがあるらしい。
アカウント名にフィッシング文を詰め込むことで、運営から送られるnoreplyメッセージにフィッシング文を載せることができる。
このメッセージを丸ごとスパムメールとして送信する攻撃手法。
正規ドメインのDKIM署名が付与されているため、受信側で正当なメールとして扱われてしまう。

https://innovatopia.jp/cyber-security/cyber-security-news/52148/
:::

## メールの暗号化
### PGP(OpenPGP)
Pretty Good Privacy。PGPは狭義にはソフトウェア名を指す。
公開鍵暗号方式を使ったメールの暗号化・デジタル署名のための規格。
署名・鍵交換・本文暗号化の3要素から構成される。
基本的には、Web of Trustで公開鍵の正当性を確保し、認証局を必要としない。
個人間のやり取りベースなので、メールアドレスごとに公開鍵/秘密鍵を用意する。
### 署名
1. 送信者がメッセージのハッシュ値に署名。
2. 受信者は送信者の公開鍵を使って、署名を検証。(改ざん検知)

#### 鍵交換
本文暗号化に用いる一時的なセッション鍵を、登録済みの相手の公開鍵を使って暗号化する。
相手は自身の秘密鍵を使ってセッション鍵を取り出し、本文を復号する。
暗号化/復号を行う必要があるので、RSAやECDHを使う。
ECDHの場合、送信者側の一時的な公開鍵も相手に送付する。

#### 本文暗号化
受信者は、鍵交換によって得た


### S/MIME
Secure/Multipurpose Internet Mail Extension
公開鍵基盤に基づく、電子メールの暗号化/署名のための規格。
メールアドレスごとに証明書を用意する。
- 送信側
 送信者の秘密鍵でメールに署名
 受信者の公開鍵で暗号化
 認証局から取得した証明書を添えて送信
- 受信側
 認証局の証明書を辿り、証明書の正当性を検証
 証明書から取り出した公開鍵を用いて署名を検証
 受信者の秘密鍵で復号
 
### SMTP over TLS
SMTP通信をTLSセッション上で行うためのプロトコル。465番ポートを使って、最初にTLSハンドシェイクを行う。
サーバ間での通信を暗号化する、なのでメールサーバごとに証明書を用意する
中継サーバを経由する場合、一度そこで復号される

送信者と送信元メールサーバ、送信元メールサーバと宛先メールサーバでそれぞれTLSセッションを貼る
宛先サーバから受信者は、別のプロトコルで暗号化することができる(IMAPS, POP3S)

### STARTTLS
平文で通信が行われるプロトコルで、通信の途中から暗号化に切り替えるための拡張機能。
通信相手がTLSをサポートしていなければ、平文のまま通信を行える。

(SMTPを例に)
1. 平文で接続開始(EHLOを送りあう)
2. クライアント->サーバにSTARTTLSコマンドを送る
3. サーバが応答する
4. TLSハンドシェイクを行い、暗号化セッションの確立
::: danger
中間者が内容を傍受、改ざんできる場合、STARTTLSコマンドそのもの(これは平文)を削除してしまえる。
:::

## スパムメールブロック
### OP25B
Outbound Port 25 Blocking.
内部ネットワークから外部のメールサーバへのTCPポート25への通信をブロックする仕組み。
ISPが自身の管理下のIPアドレスから、外部へスパムメールを送信するのをブロックするために利用される。
出張先から自社ドメインのメール(つまり、自社のメールサーバを経由して送信)したいときは、SMTPS(Port 465)やサブミッションポート(Port 587)を使うことで、

### IP25B
ISPが動的なIPアドレスから送られてくるメールをブロックする仕組み。
ISP管理下のIPアドレス内のウィルス感染者や、独自サーバから送られるスパムメールをブロックする。

### サブミッションポート
RFC 6409
TCP Port 587番のこと。クライアントからメールサーバへの送信専用ポート。
- サーバ->サーバ間のメール配送
- クライアント->サーバ間のメール配送
を分離するための枠組み。
SMTP-AUTHによって
1. EHLOを送りコネクションを確立 可能ならばSTARTTLSで暗号化)
2. SMTP AUTHで認証情報を送り、サーバがそれを認証する
3. 通常のSMTP同様、送信メールを送る
