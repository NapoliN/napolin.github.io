## OSPF
リンクステート型のルーティングプロトコル。
エリア内のルータ同士でLSA(Link State Advertisement)を交換して、同一のLSDB(Link State Database)を構築する。
LSDBにより、各ルータはエリア内のネットワーク全体を把握する。
ダイクストラ法により他ルータへの最短経路を計算し、ルーティングテーブルを計算する。

### LSAで交換される情報
#### Type1: Router LSA
全ルータが発信。
- ルータID
- 接続する全リンクの情報 (リンクの種類・コスト・隣接ルータID)
を同一エリア内をスコープとして送信。

#### Type2: Network LSA
DR(Designated Router)が発信。
- ネットワークのID
- ネットワークに接続する全ルータのID
を同一エリア内をスコープとして送信。

#### Type3: Summary LSA
ABR (Area Border Router)が発信。
- 他のエリアへの到達性
- 目的地のプレフィックスとコスト
をエリア間で送受信。

#### Type4: ASBR Summary LSA
ABR が発信。ASBRへの経路情報を伝達

#### Type5 External LSA
ASBRが発信。BGPなど他の外部ルーティングプロトコルから経路情報を取り込んで、OSPF内に広告する
- ネットワークプレフィックス (外部ネットワークのIPアドレス)
- メトリック（コスト）

### LSAの交換方法
- OSPFルータ同士でHelloパケットを送受信し、隣接関係を確立 (OSPF用のマルチキャストアドレスを利用)
- エリア内全ルータにLSAをフラッディング (受信したルータは、LSDBにその情報を追加し、他の隣接ルータにフラッディングする)

### Designated Router
Router Priority -> Router ID の高い順で選ばれる
DRを選出すると、各ルータはDR・Backup DRと隣接関係を確立

### エリア
LSAが交換される範囲。エリアがデカすぎるとネットワークがデカすぎてダイクストラするのが大変
エリアIDによって識別される。
エリアID 0のバックボーンエリアには他のエリア全てが接続する必要がある

### トポロジが変わったとき
隣接ルータは定期的にHelloパケットを交換
Helloパケットが一定期間到達しなかったとき、リンク切断と判断
LSDBを更新し、ルーティングテーブルを再計算 → 隣接ルータにもLSAをフラッディング

### 仮想リンク
エリア0が分断される/非バックボーンエリアがエリア0に直接接続できない
→ エリア境界ルータ間で仮想リンクを張る

## BGP
パスベクトル型のルーティングプロトコル。
AS番号の通過順序を管理することで経路情報を交換する。
自分がもつ経路情報に自分のAS番号を負荷して、隣接ピアに渡す、という方式

2つの
- eBGP 異なるAS間の経路情報の交換。TTLが1に設定されるので、直接接続のルータのみで交換される
- iBGP 同じAS内のBGPピア間での経路情報の交換

- グローバルAS番号 世界中で一意
- プライベートAS番号 組織内で自由に使用可能

- スタブAS 外部の単一のASとだけ接続
- トランジットAS 複数のASとマルチホーム接続し、外部AS感のトラフィックを通過させる
- 非トランジットAS 複数とマルチホーム接続してるけど、通過はさせない

### メッセージ
- OPEN バージョン・AS番号・BGPのルータID・holdtime・認証 の交換を行う
- UPDATE ルート情報を送信
- KEEPALIVE ネイバ―関係を維持するためのメッセージ 一定期間受信しないと、ダウンとみなす
- NOTIFICATION エラーを検知したときの通知メッセージ

#### UPDATE
パスアトリビュートを交換し、細かい経路制御を実現可能

##### ダウンしたとき
KEEPALIVEメッセージが一定時間届かないとき、隣接ピアがダウンと判断
- BGPテーブルを更新
- Withdrawnメッセージを広告

### 状態
BGPルータ間のピアセッションの状態は次の6種類が存在
Establishedになると経路情報の交換が可能(Updateメッセージ)
- Idle: 初期化が終わったらConnectへ
- Connect: TCPセッションが確立 → OPENメッセージを投げてOpen Sentへ 、確立に失敗したらActiveへ
- Active: TCPセッションの再試行 → TimeoutしたらIdleへ
- Open Sent: 空いてからOpenメッセージが来た → Open Confirm
- Open Confirm 相手にKeepAliveを投げる → 受信したらEstablishedへ
- Established

### 経路選択
宛先に到達可能なパスが複数存在するとき、それらのパスをBGPテーブルに格納
次の順番で優先度つけし、最も良いもののみをルーティングテーブルに載せる
1 weightの大きさ(ciscoルータ)
2 LOCAL_PREFの大きさ
3 ローカルルートが発生元
4 AS_PATHの短さ (RIP的な)
5 ORIGINが小さいもの
6 MEDが最も小さいもの
...

### as-override
ISPのPEルータが、特定のプレフィックスに対して、顧客のAS番号をISPのAS番号に書き換える
→ 顧客側で複数のサイトが同じAS番号を用いても問題なく通信できる

MPLS-VPNとか使って拠点接続してるなら、同じAS番号使った方が楽ちん
